<!DOCTYPE html>
<html>

<head>
  <title>RASTER GRIDS | CARTO VL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <script src="../dist/carto-vl.js"></script>
  <script src='https://libs.cartocdn.com/mapbox-gl/v0.48.0-carto1/mapbox-gl.js'></script>
  <link href='https://libs.cartocdn.com/mapbox-gl/v0.48.0-carto1/mapbox-gl.css' rel='stylesheet' />
  <script src="https://unpkg.com/geotiff@latest/dist/geotiff.bundle.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      height: 100%;
      width: 100%;
    }

    #timer {
      position: absolute;
      top: '20px';
      left: '20px';
      color: white;
      font-family: Arial;
      font-size: 20pt;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="timer"></div>
  <script>
    const map = new mapboxgl.Map({
      container: 'map',
      style: carto.basemaps.voyager,
      center: [0, 30],
      zoom: 1,
      dragRotate: false
    });

    carto.setDefaultAuth({
      user: 'cartovl',
      apiKey: 'default_public'
    });

    function genBand(width, height, fn) {
        const band = new Float32Array(width*height);
        for (let i=0; i<width; ++i) {
            for (let j=0; j<height; ++j) {
                band[i + j*width] = fn(i, j);
            }
        }
        return band;
    }

    function genGrid(x0, y0, x1, y1, width, height) {
        bands = [];
        const i0 = Math.floor(width/2);
        const j0 = Math.floor(height/2);
        const max = 100.0
        bands.push(genBand(width, height, (i, j) => {
          // Band0: Saddle
          const x = (i - i0)/i0;
          const y = (j - j0)/j0;
          return max*((Math.pow(x,3)-3*x*Math.pow(y,2))/4+0.5);
        }));
        const r = Math.min(width,height)*3/4;
        bands.push(genBand(width, height, (i, j) => {
          // Band1: Mountain
          const x = (i - i0)*2/r;
          const y = (j - j0)*2/r;
          return max*(Math.exp(-Math.pow(x,2)-Math.pow(y,2)));
        }));
        bands.push(genBand(width, height, (i, j) => {
          // Band2: Ramp
          return max*(i/width + j/height)/2;
        }));

        return {
          data: bands,
          bbox: [x0, y0, x1, y1],
          width: width,
          height: height
        };
    }

    const DEG2RAD = Math.PI / 180;
    const EARTH_RADIUS = 6378137;

    function projectToWebMercator (latLng) {
        let lat = latLng.lat * DEG2RAD;
        let lng = latLng.lng * DEG2RAD;
        return {
            x: lng * EARTH_RADIUS,
            y: Math.log(Math.tan(lat / 2 + Math.PI / 4)) * EARTH_RADIUS
        };
    }

    map.on('load', () => {
        const sw = projectToWebMercator({ lng: -10, lat: 20 });
        const ne = projectToWebMercator({ lng: 10, lat: 50 });
        const grid = genGrid(sw.x, sw.y, ne.x, ne.y, 150, 200);
        const sourceg = new carto.source.Grid(grid)
        const vizg = new carto.Viz(`
          // color: hsv($band0/100, 1, $band1/100);
          // color: hsv(0, 0, sqrt($band1/100));
          // color: rgb((sqrt($band1/100)>0.5)*255, 255-$band2*255/100, $band2*255/100);
          //color: rgb((sqrt($band1/100)>0.5)*255, 0, 0);
          // color: rgb(0, 255-$band2*255/100, $band2*255/100);
          color: rgb((sqrt($band1/100)<0.5)*255,  255-$band2*255/100, $band2*255/100);
          // color: hsv(0, 0, sqrt($band1/100)>0.5);
        `);
        const layerg = new carto.Layer('grid', sourceg, vizg);
        layerg.addTo(map, 'watername_ocean');

    });
  </script>
</body>

</html>
